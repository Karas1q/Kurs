<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Карта маршрута</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=a51bc3ea-6a7c-412e-bd2a-01eb6d768181&lang=ru_RU" type="text/javascript"></script>
    <style>
        html, body, #map {
            width: 100%; height: 100%; margin: 0; padding: 0;
        }

        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 6px;
            font-family: Arial, sans-serif;
            z-index: 1000;
        }

        #resetBtn, #lastRouteBtn {
            display: block;
            width: 100%;
            box-sizing: border-box;
            margin-top: 10px;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
        }

        #resetBtn {
            background-color: #1976d2;
            color: white;
        }

        #resetBtn:hover {
            background-color: #155a9c;
        }

        #lastRouteBtn {
            background-color: #388e3c;
            color: white;
        }

        #lastRouteBtn:hover {
            background-color: #2e7d32;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="controls">
    <div id="distance">Выберите точки начала и конца пути</div>
    <button id="resetBtn">Сброс</button>
    <button id="lastRouteBtn">Последний маршрут</button>
</div>

<script>
    var mapBridge = null;
    var lastRoutePoints = null;

ymaps.ready(function () {
    var myMap = new ymaps.Map("map", {
        center: [53.9, 27.5667],
        zoom: 12,
        controls: ['zoomControl', 'searchControl']
    });

    var multiRoute = new ymaps.multiRouter.MultiRoute({
        referencePoints: [],
        params: { results: 1 }
    }, {
        boundsAutoApply: true,
        wayPointVisible: true,
        routesVisible: false,
        routeActiveVisible: true,
        routeStrokeWidth: 4,
        routeActiveStrokeWidth: 6
    });

    myMap.geoObjects.add(multiRoute);

    function updateDistance() {
        var routes = multiRoute.getRoutes();
        if (routes.getLength() > 0) {
            var distanceMeters = routes.get(0).properties.get("distance").value;
            var distanceKm = (distanceMeters / 1000).toFixed(2);
            document.getElementById("distance").innerText = "Расстояние: " + distanceKm + " км";
            if (mapBridge) {
                mapBridge.setDistance(distanceKm);
            }
        } else {
            document.getElementById("distance").innerText = "Выберите точки начала и конца пути";
            if (mapBridge) {
                mapBridge.setDistance("0");
            }
        }
    }

    multiRoute.model.events.add('requestsuccess', function() {
        updateDistance();
        if (mapBridge) {
            var points = multiRoute.model.getReferencePoints();
            if (points.length === 2) {
                mapBridge.saveLastRoute(points);
            }
        }
    });

    myMap.events.add('click', function (e) {
        var points = multiRoute.model.getReferencePoints();
        if (points.length >= 2) {
            return; // Только 2 точки максимум
        }

        var coords = e.get('coords');
        points.push(coords);
        multiRoute.model.setReferencePoints(points);
    });

    document.getElementById("resetBtn").addEventListener("click", function() {
        multiRoute.model.setReferencePoints([]);
        document.getElementById("distance").innerText = "Выберите точки начала и конца пути";
        if (mapBridge) {
            mapBridge.setDistance("0");
        }
    });

    var lastRoutePoints = null;
    new QWebChannel(qt.webChannelTransport, function(channel) {
        mapBridge = channel.objects.mapBridge;

        mapBridge.lastRouteLoaded.connect(function(points) {
            if (points.length === 2) {
                multiRoute.model.setReferencePoints(points);
                lastRoutePoints = points;
            } else {
                lastRoutePoints = null;
            }
        });
    });

    document.getElementById("lastRouteBtn").addEventListener("click", function () {
        if (mapBridge) {
            mapBridge.getLastRoute();  // вызываем загрузку из C++
        }
    });

});
</script>
</body>
</html>
